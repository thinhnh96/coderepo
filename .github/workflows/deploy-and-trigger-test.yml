name: Deploy & Trigger E2E Test

on:
  push:
    branches: [ "main", "develop" ]

  workflow_dispatch:

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest

    steps:
      # -----------------------
      # Checkout source code
      # -----------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # -----------------------
      # Decide ENV based on branch
      # -----------------------
      - name: Decide environment
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "ENV=qa" >> $GITHUB_ENV
            echo "TAG=@smoke" >> $GITHUB_ENV
            echo "BASE_URL=https://www.saucedemo.com" >> $GITHUB_ENV
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "ENV=dev" >> $GITHUB_ENV
            echo "TAG=@critical" >> $GITHUB_ENV
            echo "BASE_URL=https://www.saucedemo-dev.com" >> $GITHUB_ENV
          fi

      # -----------------------
      # Giáº£ láº­p deploy
      # -----------------------
      - name: Deploy application
        run: |
          echo "ðŸš€ Deploy application to $ENV environment"
          echo "Deploy success!"

      # -----------------------
      # Trigger Playwright E2E (repo testcase)
      # -----------------------
      - name: Trigger Playwright tests (testcase repo)
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.TEST_REPO_TOKEN }}" \
            https://api.github.com/repos/thinhnh96/demoapp/dispatches \
            -d "{
              \"event_type\": \"run-e2e\",
              \"client_payload\": {
                \"env\": \"$ENV\",
                \"tag\": \"$TAG\",
                \"base_url\": \"$BASE_URL\"
              }
            }"
